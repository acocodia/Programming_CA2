{% extends 'base.html' %}

{% block title %}Booking #{{ booking.id }} - Grand Azure Hotel{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <a href="{{ url_for('bookings') }}" class="back-link">← Back to Bookings</a>
        <h1>Booking #{{ booking.id }}</h1>
        <p class="page-subtitle">View booking details</p>
    </div>
    <span class="status-badge status-{{ booking.status }} large">{{ booking.status.replace('_', ' ').title() }}</span>
</div>

<div class="booking-details-grid">
    <div class="detail-card">
        <div class="detail-card-header">
            <span class="detail-icon">◉</span>
            <h3>Guest Information</h3>
        </div>
        <div class="detail-content">
            <div class="detail-row">
                <span class="detail-label">Name</span>
                <span class="detail-value">{{ booking.guest.name }}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Phone</span>
                <span class="detail-value">{{ booking.guest.phone }}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Email</span>
                <span class="detail-value">{{ booking.guest.email or 'N/A' }}</span>
            </div>
        </div>
    </div>
    
    <div class="detail-card">
        <div class="detail-card-header">
            <span class="detail-icon">⌂</span>
            <h3>Room Information</h3>
        </div>
        <div class="detail-content">
            <div class="detail-row">
                <span class="detail-label">Room Number</span>
                <span class="detail-value">{{ booking.room.room_number }}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Room Type</span>
                <span class="detail-value">{{ booking.room.room_type.title() }}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Price/Night</span>
                <span class="detail-value">${{ "%.2f"|format(booking.room.price_per_night) }}</span>
            </div>
        </div>
    </div>
    
    <div class="detail-card">
        <div class="detail-card-header">
            <span class="detail-icon">▤</span>
            <h3>Stay Details</h3>
        </div>
        <div class="detail-content">
            <div class="detail-row">
                <span class="detail-label">Check-In</span>
                <span class="detail-value">{{ booking.check_in_date.strftime('%B %d, %Y') }}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Check-Out</span>
                <span class="detail-value">{{ booking.check_out_date.strftime('%B %d, %Y') }}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Nights</span>
                <span class="detail-value">{{ (booking.check_out_date - booking.check_in_date).days }}</span>
            </div>
            {% if booking.checked_in_at %}
            <div class="detail-row">
                <span class="detail-label">Checked In At</span>
                <span class="detail-value">{{ booking.checked_in_at.strftime('%B %d, %Y %H:%M') }}</span>
            </div>
            {% endif %}
            {% if booking.checked_out_at %}
            <div class="detail-row">
                <span class="detail-label">Checked Out At</span>
                <span class="detail-value">{{ booking.checked_out_at.strftime('%B %d, %Y %H:%M') }}</span>
            </div>
            {% endif %}
        </div>
    </div>
    
    <div class="detail-card">
        <div class="detail-card-header">
            <span class="detail-icon">◈</span>
            <h3>Payment Summary</h3>
        </div>
        <div class="detail-content">
            <div class="detail-row total">
                <span class="detail-label">Total Amount</span>
                <span class="detail-value">${{ "%.2f"|format(booking.total_amount or 0) }}</span>
            </div>
            
            {% set paid_amount = booking.payments | selectattr('payment_status', 'equalto', 'completed') | map(attribute='amount') | sum %}
            <div class="detail-row">
                <span class="detail-label">Paid</span>
                <span class="detail-value">${{ "%.2f"|format(paid_amount) }}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Balance</span>
                <span class="detail-value {% if (booking.total_amount or 0) - paid_amount > 0 %}text-danger{% else %}text-success{% endif %}">
                    ${{ "%.2f"|format((booking.total_amount or 0) - paid_amount) }}
                </span>
            </div>
            
            <a href="{{ url_for('add_payment', booking_id=booking.id) }}" class="btn btn-primary btn-sm" style="margin-top: 1rem;">
                + Record Payment
            </a>
        </div>
    </div>
</div>

{% if booking.special_requests %}
<div class="detail-card full-width">
    <div class="detail-card-header">
        <span class="detail-icon">✎</span>
        <h3>Special Requests</h3>
    </div>
    <div class="detail-content">
        <p>{{ booking.special_requests }}</p>
    </div>
</div>
{% endif %}

{% if booking.payments %}
<div class="detail-card full-width">
    <div class="detail-card-header">
        <span class="detail-icon">◈</span>
        <h3>Payment History</h3>
    </div>
    <div class="detail-content">
        <table class="data-table compact">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Amount</th>
                    <th>Method</th>
                    <th>Status</th>
                    <th>Transaction ID</th>
                </tr>
            </thead>
            <tbody>
                {% for payment in booking.payments %}
                <tr>
                    <td>{{ payment.created_at.strftime('%b %d, %Y %H:%M') }}</td>
                    <td>${{ "%.2f"|format(payment.amount) }}</td>
                    <td>{{ payment.payment_method.title() }}</td>
                    <td><span class="status-badge status-{{ payment.payment_status }}">{{ payment.payment_status.title() }}</span></td>
                    <td>{{ payment.transaction_id or '-' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<div class="booking-actions">
    {% if booking.status == 'confirmed' %}
    <a href="{{ url_for('check_in', booking_id=booking.id) }}" class="btn btn-success" onclick="return confirm('Check in this guest?')">Check In Guest</a>
    <a href="{{ url_for('cancel_booking', id=booking.id) }}" class="btn btn-danger" onclick="return confirm('Cancel this booking?')">Cancel Booking</a>
    {% elif booking.status == 'checked_in' %}
    <a href="{{ url_for('check_out', booking_id=booking.id) }}" class="btn btn-warning" onclick="return confirm('Check out this guest?')">Check Out Guest</a>
    {% endif %}
</div>
{% endblock %}

